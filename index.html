<!DOCTYPE html>
<html>
<head>
    <title>Ludus Beach Liga Razvrstitev</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        h1 {
            margin-bottom: 0;
        }

        table { 
            border-collapse: collapse; 
            position: relative;
        }

        thead th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        tbody th[rowspan] {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
        }
        tbody th {
            position: sticky;
            left: 1.5em;
            background: white;
        }

        tbody th[rowspan] {
            left: 0
        }
        th, td {
            padding: 5px;
            white-space: nowrap;
        }
        tr {
            border-top: 1px solid #666;
        }
        tr.league {
            border-top: 3px solid black;
        }

        td.highlight {
            font-weight: bold;
            color: red;
            background-color: yellow;
        }

        .hidden {
            display: none;
        }
        .hidden.not-hidden {
            display: initial;
        }

        input {
            border-radius: 0.5em;
            padding: 0.5em;
            margin-bottom: 1em;
        }

        button {
            padding: 0.5em;
            border-radius: 100vh;
            font-weight: bold;
            line-height: 1;
        }

    </style>
</head>
<body>
    <h1>Ludus beach liga razvrstitev</h1>
    <i>Podatki so iz <span id="dataAge">2024-02-03</span> <button onclick="reloadData()" id="reload">ðŸ—˜</button></i>
    <br>
    <input type="search" id="search" oninput="highlightCells(this.value)" placeholder="Najdi ekipo"/>
    <table id="leaderboard">
        <thead>
            <tr>
                <th></th>
                <th>#</th>
                <th>1. krog</th>
                <th>2. krog</th>
                <th>3. krog</th>
                <th>4. krog</th>
                <th>5. krog</th>
                <th>6. krog</th>
                <th>7. krog</th>
            </tr>
        </thead>
    </table>
    <script>
        function highlightCells(txt) {
            txt = txt.toLowerCase().replace(/ /g, '')
            for (cell of document.querySelectorAll('td')) {
                cell.classList.remove('highlight')
                cell.parentElement.parentElement.classList.remove('not-hidden')
                cell.parentElement.parentElement.classList.remove('hidden')
            }
            if (txt == "") {
                return
            }
            for (cell of document.querySelectorAll('td')) {
                cell.parentElement.parentElement.classList.add('hidden')
            }
            for (cell of document.querySelectorAll('td')) {
                if (cell.textContent.toLowerCase().replace(/ /g, '').includes(txt)) {
                    cell.classList.add('highlight')
                    cell.parentElement.parentElement.classList.remove('hidden')
                }
            }
        }
        async function getRawData() {
            let dataAge = localStorage.getItem('dataAge')
            let data = localStorage.getItem('data')
            if (dataAge == null) {
                dataAge = 1707129537787
                data = await (await fetch('data.json')).text()
                localStorage.setItem('data', data)
                localStorage.setItem('dataAge', dataAge)
            }
            document.getElementById('dataAge').textContent = new Date(+dataAge).toString()
            return JSON.parse(data)
        }

        function getDataAge() {
            return localStorage.getItem('dataAge')
        }

        async function reloadData() {
            const button = document.getElementById('reload')
            button.disabled = true
            for (let tbody of document.querySelectorAll('tbody')) {
                tbody.remove()
            }
            const list_of_links = await (await fetch('links.txt')).text()
            const pairs = list_of_links.split('\n').map(
                line => line.split(' ')
            )
            const result = await Promise.all(pairs.map(
                async ([name, link]) => {
                    let response = await fetch(link)
                    if (response.status >= 400) {
                        console.log(`Failed to fetch ${name} using ${link}`)
                        return [name, '']
                    }
                    let text = await response.text()
                    return [name, text]
                }
            ))
            localStorage.setItem('data', JSON.stringify(result))
            localStorage.setItem('dataAge', +Date.now())
            main()
            button.disabled = false
        }

        function parseCsv(txt) {
            return txt.split('\r\n').map(
                line => line.split(',')
            )
        }

        function findFinalRank(data, row, col) {
            const rank = 'KONÄŒNA RAZVRSTITEV'
            if (row != undefined && col != undefined && data[row][col] == rank) {
                return [row, col]
            }
            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < data[i].length; j++) {
                    if (data[i][j] == rank) {
                        return [i, j]
                    }
                }
            }
            return [null, null]
        }

        function extractFinalRank(data, row, col) {
            const result = []
            col++
            for (let i = row + 1; i < data.length; i++) {
                if (data[i][col] == '') {
                    break
                }
                result.push(data[i][col])
            }
            return result
        }

        function extractMeta(name) {
            [sex, _, league, _, round] = name.split('_')
            return {sex, league, round}
        }

        async function getData() {
            const rawData = await getRawData()
            rawData.sort()
            const data = rawData.map(
                ([name, txt]) => [name, parseCsv(txt)]
            )
            const result = data.map(
                ([name, csv]) => {
                    const [row, col] = findFinalRank(csv)
                    if (row == null) {
                        return [name, [], extractMeta(name)]
                    }
                    const finalRank = extractFinalRank(csv, row, col)
                    return [name, finalRank, extractMeta(name)]
                }
            )
            return result
        }

        function transposeToRows(data) {
            const transpose = (matrix) => {
                const rows = matrix.length;
                const cols = matrix.reduce((maxLen, row) => Math.max(maxLen, row.length), 0);
                const result = Array.from({length: cols}, () => Array(rows).fill(""));
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < matrix[i].length; j++) {
                        result[j][i] = matrix[i][j];
                    }
                }
                return result;
            }
            const result = []
            let prevMeta = {round: 0};
            let group = []
            for ([name, ranks, meta] of data) {
                if (prevMeta.round > meta.round) {
                    result.push([prevMeta, transpose(group)])
                    group = []
                }
                group.push(ranks)
                prevMeta = meta
            }
            result.push([prevMeta, transpose(group)])
            return result
        }

        function renderTable(data) {
            const table = document.querySelector('#leaderboard')
            const rows = transposeToRows(data)
            const sex = {m: 'MoÅ¡ki', Å¾: 'Å½enske'}
            let rank = 1
            let prevLen = 0
            let prevSex = ''
            for ([meta, ranks] of rows) {
                const tbody = document.createElement('tbody')
                const correction = meta.league.endsWith('b') ? prevLen : 0
                if (prevSex != meta.sex) rank = 1
                prevSex = meta.sex
                prevLen = ranks.length
                tbody.appendChild(renderRow(ranks[0], rank++ - correction, `${sex[meta.sex]} ${meta.league}`, ranks.length))
                for (let row of ranks.slice(1)) {
                    tbody.appendChild(renderRow(row, rank++ - correction))
                }
                table.appendChild(tbody)
            }
        }

        function renderRow(row, rank, league, numRows) {
            const tr = document.createElement('tr')
            if (league) {
                const th = document.createElement('th')
                th.textContent = league
                th.rowSpan = numRows
                tr.appendChild(th)
                tr.classList.add('league')
            }
            const rankTd = document.createElement('th')
            rankTd.textContent = rank
            tr.appendChild(rankTd)
            for (let cell of row) {
                const td = document.createElement('td')
                td.textContent = cell
                td.addEventListener('click', () => {
                    const search = document.getElementById('search')
                    search.value = cell
                    search.dispatchEvent(new Event('input'));
                })
                tr.appendChild(td)
            }
            return tr
        }

        function main() {
            getData().then(renderTable)
        }

        main()

    </script>
</body>
</html>
